<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24å¤©ä¸­æ­å†¬å­£å¤§çœ¾é‹è¼¸ä¹‹æ—… (2026)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; }
        .leaflet-container { height: 100%; width: 100%; z-index: 10; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Reset Leaflet DivIcon default background */
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }
        /* Mobile Safe Area for Bottom Navigation */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Helper: Get Color based on Type
        const getCategoryColor = (type) => {
            if (['äº¤é€š', 'è¿”å›', 'æ­æ©Ÿ', 'ç§»å‹•'].some(k => type.includes(k))) return 'bg-gray-500';
            if (type.includes('ä½å®¿')) return 'bg-purple-600';
            if (['é¤é£²', 'å°åƒ', 'ç¾é£Ÿ'].some(k => type.includes(k))) return 'bg-red-500';
            return 'bg-blue-600';
        };

        // Helper: Get Country based on City
        const getCountry = (city) => {
             const map = {
                'Munich': 'å¾·åœ‹', 'FÃ¼ssen': 'å¾·åœ‹', 'Dresden': 'å¾·åœ‹', 'Berlin': 'å¾·åœ‹',
                'Salzburg': 'å¥§åœ°åˆ©', 'Hallstatt': 'å¥§åœ°åˆ©', 'Vienna': 'å¥§åœ°åˆ©',
                'Budapest': 'åŒˆç‰™åˆ©',
                'Prague': 'æ·å…‹', 'Cesky Krumlov': 'æ·å…‹'
            };
            return map[city] || 'å…¶ä»–';
        };

        // --- Data: 24 Days Itinerary ---
        const itineraryData = [
            // --- å¾·åœ‹ï¼šæ…•å°¼é»‘ (Days 1-3) ---
            {
                day: 1,
                date: "02/07 (å…­)",
                title: "æŠµé”æ…•å°¼é»‘ | å·´ä¼åˆ©äºé¦–åºœåˆæ¢",
                city: "Munich",
                coordinates: [48.1351, 11.5820],
                summary: "æŠµé”æ…•å°¼é»‘æ©Ÿå ´ (MUC)ï¼Œå‰å¾€å¸‚å€è¾¦ç†å…¥ä½ï¼Œé©æ‡‰æ™‚å·®ä¸¦äº«ç”¨æ™šé¤ã€‚",
                tickets: "è³¼è²·æ©Ÿå ´åŸå¸‚å¿«éµç¥¨ (S-Bahn) æˆ– MVV Day Ticketã€‚",
                notes: "å†¬å­£æ—¥è½ç´„ 17:15ï¼Œå»ºè­°æ—©é» check-inã€‚æº–å‚™å¥½ä¿æš–è¡£ç‰©ã€‚",
                spots: [
                    { name: "æ…•å°¼é»‘æ©Ÿå ´ (MUC)", type: "äº¤é€š", time: "14:00 | æŠµé”", trans: "S-Bahn S1 æˆ– S8 (ç´„40åˆ†)", lat: 48.3536, lng: 11.7750 },
                    { name: "æ…•å°¼é»‘ä¸­å¤®è»Šç«™å‘¨é‚Š", type: "ä½å®¿", time: "16:00 | Check-in", trans: "æ­¥è¡Œ", lat: 48.1404, lng: 11.5600 },
                    { name: "ç‘ªéº—æ©å»£å ´ (Marienplatz)", type: "æ™¯é»", time: "18:00 | 2å°æ™‚", trans: "S-Bahn/U-Bahn è‡³ Marienplatz", lat: 48.1372, lng: 11.5755 }
                ]
            },
            {
                day: 2,
                date: "02/08 (æ—¥)",
                title: "æ…•å°¼é»‘ | çš‡å®®èˆ‡å•¤é…’æ–‡åŒ–",
                city: "Munich",
                coordinates: [48.1402, 11.5782],
                summary: "åƒè§€æ…•å°¼é»‘ç‹å®®ï¼Œåˆå¾Œæ¼«æ­¥è‹±åœ‹èŠ±åœ’ï¼Œæ™šä¸Šé«”é©—çš‡å®¶å•¤é…’å±‹ã€‚",
                tickets: "æ…•å°¼é»‘ç‹å®®è¯ç¥¨ (Residenz + Treasury)ã€‚äº¤é€šä½¿ç”¨ MVV Inner District æ—¥ç¥¨ã€‚",
                notes: "é€±æ—¥å•†åº—å¤§å¤šé—œé–‰ï¼Œä½†åšç‰©é¤¨èˆ‡é¤å»³ç…§å¸¸ç‡Ÿæ¥­ã€‚",
                spots: [
                    { name: "æ…•å°¼é»‘ç‹å®® (Residenz)", type: "æ™¯é»", time: "09:30 | 3å°æ™‚", trans: "U-Bahn U3/U6 è‡³ Odeonsplatz", lat: 48.1402, lng: 11.5782 },
                    { name: "è‹±åœ‹èŠ±åœ’ (Englischer Garten)", type: "æ™¯é»", time: "14:00 | 1.5å°æ™‚", trans: "æ­¥è¡Œæˆ–å·´å£« 100", lat: 48.1534, lng: 11.5925 },
                    { name: "çš‡å®¶å•¤é…’å±‹ (HofbrÃ¤uhaus)", type: "é¤é£²", time: "18:00 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 48.1375, lng: 11.5796 }
                ]
            },
            {
                day: 3,
                date: "02/09 (ä¸€)",
                title: "å¯Œæ£® | æ–°å¤©éµå ¡ä¸€æ—¥éŠ",
                city: "FÃ¼ssen",
                coordinates: [47.5576, 10.7498],
                summary: "æ­ä¹˜ç«è»Šå‰å¾€å¯Œæ£®ï¼Œè½‰ä¹˜å·´å£«ä¸Šå±±åƒè§€ç«¥è©±åŸå ¡ã€‚",
                tickets: "æ‹œä»é‚¦ç¥¨ (Bayern Ticket) æœ€åˆ’ç®—ã€‚åŸå ¡é–€ç¥¨éœ€æå‰ä¸€å€‹æœˆå®˜ç¶²é è¨‚ã€‚",
                notes: "å†¬å­£ç‘ªéº—å®‰æ©‹ (MarienbrÃ¼cke) å¯èƒ½å› çµå†°å°é–‰ã€‚å‹™å¿…æ³¨æ„ç«è»Šç­æ¬¡ã€‚",
                spots: [
                    { name: "æ…•å°¼é»‘ä¸­å¤®è»Šç«™", type: "äº¤é€š", time: "08:30 | å‡ºç™¼", trans: "RE åˆ—è»Š (ç´„2å°æ™‚)", lat: 48.1404, lng: 11.5600 },
                    { name: "æ–°å¤©éµå ¡ (Neuschwanstein)", type: "æ™¯é»", time: "11:30 | 3å°æ™‚", trans: "å¯Œæ£®è»Šç«™è½‰ Bus 73/78", lat: 47.5576, lng: 10.7498 },
                    { name: "æ…•å°¼é»‘å¸‚å€", type: "è¿”å›", time: "19:00 | æŠµé”", trans: "RE åˆ—è»Š", lat: 48.1351, lng: 11.5820 }
                ]
            },
            // --- å¥§åœ°åˆ©ï¼šè–©çˆ¾æ–¯å ¡ (Days 4-6) ---
            {
                day: 4,
                date: "02/10 (äºŒ)",
                title: "ç§»å‹•æ—¥ | å‰å¾€è–©çˆ¾æ–¯å ¡",
                city: "Salzburg",
                coordinates: [47.8095, 13.0550],
                summary: "æ—©æ™¨æ­ç«è»Šè·¨åœ‹å‰å¾€å¥§åœ°åˆ©è–©çˆ¾æ–¯å ¡ï¼Œä¸‹åˆéŠè¦½ç±³æ‹‰è²çˆ¾å®®ã€‚",
                tickets: "ä½¿ç”¨æ‹œä»é‚¦ç¥¨ (å¯æ¶µè“‹è‡³ Salzburg Hbf) æˆ–é è³¼ DB/Ã–BB æ—©é³¥ç¥¨ã€‚",
                notes: "è–©çˆ¾æ–¯å ¡å¡ (Salzburg Card) æ¥µåŠ›æ¨è–¦ï¼ŒåŒ…å«äº¤é€šèˆ‡æ™¯é»ã€‚",
                spots: [
                    { name: "æ…•å°¼é»‘ -> è–©çˆ¾æ–¯å ¡", type: "äº¤é€š", time: "09:00 | 1.5-2å°æ™‚", trans: "Meridian (M) æˆ– RJX ç«è»Š", lat: 47.8129, lng: 13.0454 },
                    { name: "ç±³æ‹‰è²çˆ¾å®® (Mirabellgarten)", type: "æ™¯é»", time: "14:00 | 1.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.8055, lng: 13.0416 },
                    { name: "ç³§é£Ÿèƒ¡åŒ (Getreidegasse)", type: "é€›è¡—", time: "16:30 | 2å°æ™‚", trans: "æ­¥è¡Œéæ©‹", lat: 47.7997, lng: 13.0425 }
                ]
            },
            {
                day: 5,
                date: "02/11 (ä¸‰)",
                title: "è–©çˆ¾æ–¯å ¡ | è¦å¡èˆ‡è«æœ­ç‰¹",
                city: "Salzburg",
                coordinates: [47.7949, 13.0475],
                summary: "ç™»ä¸Šè–©çˆ¾æ–¯å ¡è¦å¡ä¿¯ç°é›ªæ™¯ï¼Œåƒè§€è«æœ­ç‰¹å‡ºç”Ÿåœ°ã€‚",
                tickets: "ä½¿ç”¨è–©çˆ¾æ–¯å ¡å¡ (åŒ…å«çºœè»Šã€è¦å¡é–€ç¥¨ã€è«æœ­ç‰¹æ•…å±…)ã€‚",
                notes: "å†¬å­£åŸå ¡çºœè»Šç‡Ÿé‹æ­£å¸¸ï¼Œä½†æˆ¶å¤–é¢¨å¤§è«‹ä¿æš–ã€‚",
                spots: [
                    { name: "è–©çˆ¾æ–¯å ¡è¦å¡ (Festung)", type: "æ™¯é»", time: "09:30 | 2.5å°æ™‚", trans: "Festungsbahn çºœè»Š", lat: 47.7949, lng: 13.0475 },
                    { name: "è«æœ­ç‰¹å‡ºç”Ÿåœ°", type: "æ™¯é»", time: "13:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.8000, lng: 13.0436 },
                    { name: "è–©çˆ¾æ–¯å ¡å¤§æ•™å ‚", type: "æ™¯é»", time: "15:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.7979, lng: 13.0450 }
                ]
            },
            {
                day: 6,
                date: "02/12 (å››)",
                title: "å“ˆä¿®å¡”ç‰¹ | ä¸–ç•Œæœ€ç¾å°é®ä¸€æ—¥éŠ",
                city: "Hallstatt",
                coordinates: [47.5622, 13.6493],
                summary: "å¤§çœ¾é‹è¼¸æŒ‘æˆ°ï¼šå·´å£«è½‰ç«è»Šè½‰èˆ¹ï¼Œæ¢è¨ªæ¹–ç•”å°é®ã€‚",
                tickets: "å·´å£«ä¸Šè»Šè³¼ç¥¨æˆ– OBB App è²·å…¨ç¨‹ç¥¨ã€‚æ¸¡è¼ªç¾é‡‘æ”¯ä»˜ã€‚",
                notes: "å†¬å­£é¹½ç¤¦é—œé–‰(é€šå¸¸1-2æœˆ)ï¼Œé‡é»åœ¨æ¹–æ™¯èˆ‡å¤©ç©ºæ­¥é“(è‹¥é–‹æ”¾)ã€‚æœ«ç­è»Šè¼ƒæ—©ï¼Œå‹™å¿… 16:30 å‰é›¢é–‹ã€‚",
                spots: [
                    { name: "è–©çˆ¾æ–¯å ¡ -> å“ˆä¿®å¡”ç‰¹", type: "äº¤é€š", time: "08:15 | 2.5å°æ™‚", trans: "Bus 150 -> Bad Ischl -> Train -> Ferry", lat: 47.5622, lng: 13.6493 },
                    { name: "å“ˆä¿®å¡”ç‰¹æ˜ä¿¡ç‰‡è§€æ™¯é»", type: "æ™¯é»", time: "11:30 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.5645, lng: 13.6506 },
                    { name: "é›†å¸‚å»£å ´ (Marktplatz)", type: "æ™¯é»", time: "13:30 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.5620, lng: 13.6490 }
                ]
            },
            // --- å¥§åœ°åˆ©ï¼šç¶­ä¹Ÿç´ (Days 7-10) ---
            {
                day: 7,
                date: "02/13 (äº”)",
                title: "ç§»å‹•æ—¥ | å‰å¾€éŸ³æ¨‚ä¹‹éƒ½ç¶­ä¹Ÿç´",
                city: "Vienna",
                coordinates: [48.1851, 16.3762],
                summary: "æ­ä¹˜ Railjet é«˜é€Ÿåˆ—è»Šå‰å¾€ç¶­ä¹Ÿç´ï¼Œå…¥ä½ä¸­å¤®è»Šç«™é™„è¿‘ã€‚",
                tickets: "Ã–BB Railjet é å”®ç¥¨ (Sparschiene)ã€‚ç¶­ä¹Ÿç´äº¤é€šé€±ç¥¨ (Wochenkarte) æˆ– 72hr åˆ¸ã€‚",
                notes: "ç¶­ä¹Ÿç´ä¸­å¤®è»Šç«™ (Wien Hbf) ç”Ÿæ´»æ©Ÿèƒ½å¼·ï¼Œè¶…å¸‚å¤šã€‚",
                spots: [
                    { name: "è–©çˆ¾æ–¯å ¡ -> ç¶­ä¹Ÿç´", type: "äº¤é€š", time: "09:08 | 2.5å°æ™‚", trans: "Ã–BB Railjet (RJX)", lat: 48.1851, lng: 16.3762 },
                    { name: "è²çˆ¾ç»´å¾·å®® (Belvedere)", type: "æ™¯é»", time: "14:00 | 2.5å°æ™‚", trans: "æ­¥è¡Œæˆ–é›»è»Š D ç·š", lat: 48.1915, lng: 16.3809 },
                    { name: "å¡çˆ¾æ•™å ‚ (Karlskirche)", type: "æ™¯é»", time: "17:00 | 1å°æ™‚", trans: "U-Bahn U1", lat: 48.1982, lng: 16.3718 }
                ]
            },
            {
                day: 8,
                date: "02/14 (å…­)",
                title: "ç¶­ä¹Ÿç´ | ç†Šå¸ƒæœ—å®®èˆ‡å¸‚å€",
                city: "Vienna",
                coordinates: [48.1848, 16.3122],
                summary: "åƒè§€ç¾æ³‰å®® (ç†Šå¸ƒæœ—å®®)ï¼Œä¸‹åˆå›åˆ°å…§åŸå€é€›è¡—ã€‚",
                tickets: "ç¾æ³‰å®® Sisi Ticket æˆ– Grand Tour éœ€é ç´„æ™‚æ®µã€‚",
                notes: "æƒ…äººç¯€æ™šé¤å»ºè­°æå‰ä¸€å€‹æœˆé è¨‚ã€‚",
                spots: [
                    { name: "ç¾æ³‰å®® (SchÃ¶nbrunn)", type: "æ™¯é»", time: "09:30 | 3.5å°æ™‚", trans: "U-Bahn U4", lat: 48.1848, lng: 16.3122 },
                    { name: "è–å²è’‚èŠ¬å¤§æ•™å ‚", type: "æ™¯é»", time: "14:30 | 1.5å°æ™‚", trans: "U-Bahn U1/U3", lat: 48.2085, lng: 16.3738 },
                    { name: "è‘›æ‹‰æœ¬å¤§è¡— (Graben)", type: "é€›è¡—", time: "16:00 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 48.2088, lng: 16.3698 }
                ]
            },
            {
                day: 9,
                date: "02/15 (æ—¥)",
                title: "ç¶­ä¹Ÿç´ | è—è¡“å²èˆ‡å’–å•¡é¤¨",
                city: "Vienna",
                coordinates: [48.2038, 16.3617],
                summary: "æ²‰æµ¸åœ¨è—è¡“å²åšç‰©é¤¨ï¼Œä¸‹åˆé«”é©—ç¶­ä¹Ÿç´å’–å•¡æ–‡åŒ–ã€‚",
                tickets: "è—è¡“å²åšç‰©é¤¨é–€ç¥¨ã€‚",
                notes: "ä¸­å¤®å’–å•¡é¤¨ (CafÃ© Central) ç¶“å¸¸æ’éšŠï¼Œå¯æ”¹å» CafÃ© Sperlã€‚",
                spots: [
                    { name: "è—è¡“å²åšç‰©é¤¨", type: "æ™¯é»", time: "10:00 | 3å°æ™‚", trans: "U-Bahn U2/U3", lat: 48.2038, lng: 16.3617 },
                    { name: "éœå¤«å ¡çš‡å®® (Hofburg)", type: "æ™¯é»", time: "14:00 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 48.2056, lng: 16.3653 },
                    { name: "ä¸­å¤®å’–å•¡é¤¨", type: "é¤é£²", time: "16:30 | 1.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 48.2104, lng: 16.3654 }
                ]
            },
            {
                day: 10,
                date: "02/16 (ä¸€)",
                title: "ç§»å‹•æ—¥ | å‰å¾€å¸ƒé”ä½©æ–¯",
                city: "Budapest",
                coordinates: [47.5005, 19.0837],
                summary: "æ­ç«è»Šè·¨è¶Šåœ‹ç•Œå‰å¾€åŒˆç‰™åˆ©å¸ƒé”ä½©æ–¯ã€‚",
                tickets: "Ã–BB æˆ– MÃV å®˜ç¶²è³¼ç¥¨ã€‚å¸ƒé”ä½©æ–¯è³¼è²· 72hr Travel Cardã€‚",
                notes: "æ³¨æ„å¸ƒé”ä½©æ–¯æœ‰ä¸åŒç«è»Šç«™ (Keleti/Nyugati)ï¼Œç¢ºèªè»Šç¥¨ã€‚",
                spots: [
                    { name: "ç¶­ä¹Ÿç´ -> å¸ƒé”ä½©æ–¯", type: "äº¤é€š", time: "10:40 | 2.5å°æ™‚", trans: "Ã–BB Railjet -> Budapest-Keleti", lat: 47.5005, lng: 19.0837 },
                    { name: "ç´ç´„å’–å•¡é¤¨ (New York CafÃ©)", type: "é¤é£²", time: "15:00 | 1.5å°æ™‚", trans: "Bus/Tram/Metro", lat: 47.4985, lng: 19.0705 },
                    { name: "å¤šç‘™æ²³éŠèˆ¹", type: "é«”é©—", time: "19:00 | 1å°æ™‚", trans: "Tram 2", lat: 47.4967, lng: 19.0494 }
                ]
            },
            // --- åŒˆç‰™åˆ©ï¼šå¸ƒé”ä½©æ–¯ (Days 11-13) ---
            {
                day: 11,
                date: "02/17 (äºŒ)",
                title: "å¸ƒé”ä½©æ–¯ | å¸ƒé”å€æ­·å²æ¼«æ­¥",
                city: "Budapest",
                coordinates: [47.5020, 19.0348],
                summary: "æ¢ç´¢å¤šç‘™æ²³è¥¿å²¸çš„å¸ƒé”åŸå ¡å€ï¼Œä¿¯ç°åŸå¸‚å…¨æ™¯ã€‚",
                tickets: "é¦¬æäºæ–¯æ•™å ‚é–€ç¥¨ï¼Œæ¼äººå ¡ä¸Šå±¤éœ€ç¥¨(å†¬å­£æœ‰æ™‚å…è²»)ã€‚",
                notes: "Bus 16 å¯ç›´æ¥ä¸ŠåŸå ¡å±±ã€‚",
                spots: [
                    { name: "æ¼äººå ¡ (Fisherman's Bastion)", type: "æ™¯é»", time: "09:30 | 1.5å°æ™‚", trans: "Bus 16", lat: 47.5020, lng: 19.0348 },
                    { name: "é¦¬æäºæ–¯æ•™å ‚", type: "æ™¯é»", time: "11:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.5019, lng: 19.0342 },
                    { name: "å¸ƒé”çš‡å®® (Buda Castle)", type: "æ™¯é»", time: "14:00 | 2å°æ™‚", trans: "æ­¥è¡Œæˆ–çºœè»Š", lat: 47.4962, lng: 19.0396 }
                ]
            },
            {
                day: 12,
                date: "02/18 (ä¸‰)",
                title: "å¸ƒé”ä½©æ–¯ | ä½©æ–¯å€èˆ‡æº«æ³‰",
                city: "Budapest",
                coordinates: [47.5076, 19.0456],
                summary: "åƒè§€å®å‰çš„åœ‹æœƒå¤§å»ˆï¼Œä¸‹åˆäº«å—è‘—åçš„å¡åˆ‡å°¼æº«æ³‰ã€‚",
                tickets: "åœ‹æœƒå¤§å»ˆå‹™å¿…æå‰å®˜ç¶²é ç´„å°è¦½ã€‚æº«æ³‰è‡ªå‚™æ³³è¡£æ‹–é‹ã€‚",
                notes: "åœ‹æœƒå¤§å»ˆå®‰æª¢åš´æ ¼ã€‚å†¬å­£æ³¡éœ²å¤©æº«æ³‰æ˜¯ç¨ç‰¹é«”é©—ã€‚",
                spots: [
                    { name: "åŒˆç‰™åˆ©åœ‹æœƒå¤§å»ˆ", type: "æ™¯é»", time: "10:00 | 1.5å°æ™‚", trans: "Metro M2 Kossuth Lajos tÃ©r", lat: 47.5076, lng: 19.0456 },
                    { name: "å¡åˆ‡å°¼æº«æ³‰ (SzÃ©chenyi)", type: "é«”é©—", time: "15:00 | 3å°æ™‚", trans: "Metro M1 SzÃ©chenyi fÃ¼rdÅ‘", lat: 47.5186, lng: 19.0822 },
                    { name: "è‹±é›„å»£å ´", type: "æ™¯é»", time: "18:00 | 0.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.5138, lng: 19.0778 }
                ]
            },
             {
                day: 13,
                date: "02/19 (å››)",
                title: "å¸ƒé”ä½©æ–¯ | ä¸­å¤®å¸‚å ´èˆ‡æ¼«éŠ",
                city: "Budapest",
                coordinates: [47.4870, 19.0585],
                summary: "æ¢ç´¢ç•¶åœ°ç¾é£Ÿï¼Œè³¼è²·ä¼´æ‰‹ç¦®ï¼Œæ¼«æ­¥ç“¦èŒ¨è¡—ã€‚",
                tickets: "ç„¡ç‰¹æ®Šé–€ç¥¨ã€‚",
                notes: "ä¸­å¤®å¸‚å ´äºŒæ¨“æœ‰ç†Ÿé£Ÿæ”¤è²©ï¼Œé©åˆåˆé¤ã€‚",
                spots: [
                    { name: "ä¸­å¤®å¸‚å ´ (Great Market Hall)", type: "é€›è¡—", time: "10:00 | 2å°æ™‚", trans: "Tram 47/49", lat: 47.4870, lng: 19.0585 },
                    { name: "ç“¦èŒ¨è¡— (VÃ¡ci utca)", type: "é€›è¡—", time: "14:00 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.4933, lng: 19.0523 },
                    { name: "è‡ªç”±æ©‹ (Liberty Bridge)", type: "æ™¯é»", time: "16:30 | 0.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 47.4856, lng: 19.0547 }
                ]
            },
            // --- æ·å…‹ï¼šå¸ƒæ‹‰æ ¼ (Days 14-18) ---
            {
                day: 14,
                date: "02/20 (äº”)",
                title: "ç§»å‹•æ—¥ | å‰å¾€å¸ƒæ‹‰æ ¼",
                city: "Prague",
                coordinates: [50.0835, 14.4362],
                summary: "é•·é€”ç§»å‹•æ—¥ï¼Œæ­ç«è»Šå‰å¾€æ·å…‹å¸ƒæ‹‰æ ¼ã€‚",
                tickets: "MÃV æˆ– CD (æ·å…‹åœ‹éµ) è¨‚ç¥¨ã€‚å¸ƒæ‹‰æ ¼ä½¿ç”¨ PID ç¥¨åˆ¸ã€‚",
                notes: "è»Šç¨‹è¼ƒé•· (ç´„ 7 å°æ™‚)ï¼Œå»ºè­°æº–å‚™åˆé¤ä¸Šè»Šã€‚æŠµé”ç«™é€šå¸¸ç‚º Praha hl.n.ã€‚",
                spots: [
                    { name: "å¸ƒé”ä½©æ–¯ -> å¸ƒæ‹‰æ ¼", type: "äº¤é€š", time: "09:30 | 7å°æ™‚", trans: "EC åˆ—è»Š (ç¶“ Bratislava/Brno)", lat: 50.0835, lng: 14.4362 },
                    { name: "ç“¦èŒ¨æ‹‰å¤«å»£å ´", type: "æ™¯é»", time: "17:30 | 1å°æ™‚", trans: "æ­¥è¡Œ/Metro", lat: 50.0813, lng: 14.4280 }
                ]
            },
            {
                day: 15,
                date: "02/21 (å…­)",
                title: "å¸ƒæ‹‰æ ¼ | è€åŸå€ç¶“å…¸",
                city: "Prague",
                coordinates: [50.0877, 14.4211],
                summary: "èµ°è¨ªå¤©æ–‡é˜ã€è€åŸå»£å ´èˆ‡æŸ¥ç†å¤§æ©‹ã€‚",
                tickets: "è€åŸå¸‚æ”¿å»³ç™»å¡”ç¥¨ã€‚",
                notes: "æŸ¥ç†å¤§æ©‹æ¸…æ™¨æˆ–æ·±å¤œäººæœ€å°‘ï¼Œæ°£æ°›æœ€ä½³ã€‚",
                spots: [
                    { name: "è€åŸå»£å ´ (Old Town Square)", type: "æ™¯é»", time: "09:30 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 50.0877, lng: 14.4211 },
                    { name: "å¤©æ–‡é˜ (Astronomical Clock)", type: "æ™¯é»", time: "11:00 | 0.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 50.0870, lng: 14.4207 },
                    { name: "æŸ¥ç†å¤§æ©‹ (Charles Bridge)", type: "æ™¯é»", time: "15:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 50.0865, lng: 14.4114 }
                ]
            },
            {
                day: 16,
                date: "02/22 (æ—¥)",
                title: "å¸ƒæ‹‰æ ¼ | åŸå ¡å€å·¡ç¦®",
                city: "Prague",
                coordinates: [50.0909, 14.4005],
                summary: "ä¸–ç•Œæœ€å¤§å¤å ¡ç¾¤ï¼ŒåŒ…å«è–ç¶­ç‰¹å¤§æ•™å ‚èˆ‡é»ƒé‡‘å··ã€‚",
                tickets: "å¸ƒæ‹‰æ ¼åŸå ¡ Circuit B (åŒ…å«å¤§æ•™å ‚ã€èˆŠçš‡å®®ã€é»ƒé‡‘å··)ã€‚",
                notes: "é€²å…¥åŸå ¡å€éœ€å®‰æª¢ã€‚æ˜Ÿå·´å…‹åŸå ¡åº—æœ‰çµ•ä½³è§€æ™¯å°ã€‚",
                spots: [
                    { name: "å¸ƒæ‹‰æ ¼åŸå ¡ (Prague Castle)", type: "æ™¯é»", time: "09:30 | 4å°æ™‚", trans: "Tram 22 è‡³ PraÅ¾skÃ½ hrad", lat: 50.0909, lng: 14.4005 },
                    { name: "è–ç¶­ç‰¹å¤§æ•™å ‚", type: "æ™¯é»", time: "11:00 | åŒ…å«", trans: "æ­¥è¡Œ", lat: 50.0906, lng: 14.4005 },
                    { name: "å°åŸå€ (MalÃ¡ Strana)", type: "é€›è¡—", time: "15:00 | 2å°æ™‚", trans: "æ­¥è¡Œä¸‹å±±", lat: 50.0883, lng: 14.4042 }
                ]
            },
            {
                day: 17,
                date: "02/23 (ä¸€)",
                title: "åº«å€«æ´›å¤« | CK å°é®ä¸€æ—¥éŠ",
                city: "Cesky Krumlov",
                coordinates: [48.8105, 14.3142],
                summary: "æ­ä¹˜å·´å£«ç•¶æ—¥å¾€è¿”é€™åº§è¢«ä¼çˆ¾å¡”ç“¦æ²³ç’°ç¹çš„ä¸­ä¸–ç´€å°é®ã€‚",
                tickets: "RegioJet æˆ– FlixBus å·´å£«ç¥¨ (å‹™å¿…ä¾†å›å…ˆè²·å¥½)ã€‚",
                notes: "å°é®ç‚ºçŸ³æ¿è·¯ï¼Œè‹¥æœ‰ç©é›ªè«‹ç©¿é˜²æ»‘é‹ã€‚å¾å·´å£«ç«™åˆ°å¸‚å€éœ€æ­¥è¡Œç´„15åˆ†ã€‚",
                spots: [
                    { name: "å¸ƒæ‹‰æ ¼ -> CK å°é®", type: "äº¤é€š", time: "08:00 | 3å°æ™‚", trans: "RegioJet Bus (Na KnÃ­Å¾ecÃ­ ç«™ç™¼è»Š)", lat: 48.8105, lng: 14.3142 },
                    { name: "CK åŸå ¡èˆ‡å½©ç¹ªå¡”", type: "æ™¯é»", time: "11:30 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 48.8126, lng: 14.3130 },
                    { name: "èˆŠåŸå»£å ´", type: "æ™¯é»", time: "14:00 | 2å°æ™‚", trans: "æ­¥è¡Œ", lat: 48.8107, lng: 14.3152 },
                    { name: "è¿”å›å¸ƒæ‹‰æ ¼", type: "äº¤é€š", time: "17:00 | 3å°æ™‚", trans: "Bus", lat: 50.0682, lng: 14.4053 }
                ]
            },
            {
                day: 18,
                date: "02/24 (äºŒ)",
                title: "å¸ƒæ‹‰æ ¼ | æ–‡é’èˆ‡é«˜å ¡",
                city: "Prague",
                coordinates: [50.0645, 14.4179],
                summary: "ä¸Šåˆæ‹œè¨ªæœƒè·³èˆçš„æˆ¿å­ï¼Œä¸‹åˆè‡³é«˜å ¡å€ä¿¯ç°ä¼çˆ¾å¡”ç“¦æ²³ã€‚",
                tickets: "é«˜å ¡å€ä¸»è¦å…è²»ï¼Œæ•™å ‚éœ€é–€ç¥¨ã€‚",
                notes: "é«˜å ¡å€éŠå®¢è¼ƒå°‘ï¼Œè¦–é‡æ¥µä½³ã€‚",
                spots: [
                    { name: "è·³èˆçš„æˆ¿å­", type: "æ™¯é»", time: "10:00 | 0.5å°æ™‚", trans: "Tram 17", lat: 50.0754, lng: 14.4141 },
                    { name: "é«˜å ¡ (VyÅ¡ehrad)", type: "æ™¯é»", time: "14:00 | 2.5å°æ™‚", trans: "Metro C è‡³ VyÅ¡ehrad", lat: 50.0645, lng: 14.4179 }
                ]
            },
             // --- å¾·åœ‹ï¼šå¾·å‹’æ–¯ç™»/æŸæ— (Days 19-24) ---
            {
                day: 19,
                date: "02/25 (ä¸‰)",
                title: "ç§»å‹•æ—¥ | ç¶“å¾·å‹’æ–¯ç™»è‡³æŸæ—",
                city: "Dresden",
                coordinates: [51.0504, 13.7373],
                summary: "å¾å¸ƒæ‹‰æ ¼å‡ºç™¼ï¼Œä¸­åœã€Œæ˜“åŒ—æ²³ç•”çš„ä½›ç¾…å€«æ–¯ã€å¾·å‹’æ–¯ç™»åŠæ—¥ï¼Œæ™šé–“æŠµé”æŸæ—ã€‚",
                tickets: "DB/CD è·¨åœ‹ç«è»Šç¥¨ (è²· Prague -> Berlinï¼Œéƒ¨åˆ†ç¥¨ç¨®å…è¨±ä¸­åœï¼Œæˆ–åˆ†æ®µè²·)ã€‚",
                notes: "å¾·å‹’æ–¯ç™»è»Šç«™æœ‰ç½®ç‰©æ«ƒå¯æ”¾è¡Œæã€‚",
                spots: [
                    { name: "å¸ƒæ‹‰æ ¼ -> å¾·å‹’æ–¯ç™»", type: "äº¤é€š", time: "08:30 | 2.5å°æ™‚", trans: "EC åˆ—è»Š", lat: 51.0406, lng: 13.7314 },
                    { name: "è–æ¯æ•™å ‚ (Frauenkirche)", type: "æ™¯é»", time: "12:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 51.0519, lng: 13.7415 },
                    { name: "èŒ²æº«æ ¼å®® (Zwinger)", type: "æ™¯é»", time: "14:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 51.0529, lng: 13.7337 },
                    { name: "å¾·å‹’æ–¯ç™» -> æŸæ—", type: "äº¤é€š", time: "17:00 | 2å°æ™‚", trans: "IC/EC åˆ—è»Š", lat: 52.5200, lng: 13.4050 }
                ]
            },
            {
                day: 20,
                date: "02/26 (å››)",
                title: "æŸæ— | æ­·å²çš„å‚·ç—•",
                city: "Berlin",
                coordinates: [52.5163, 13.3777],
                summary: "åƒè§€å¸ƒè˜­ç™»å ¡é–€ã€åœ‹æœƒå¤§å»ˆèˆ‡æ­æ´²è¢«å®³çŒ¶å¤ªäººç´€å¿µç¢‘ã€‚",
                tickets: "åœ‹æœƒå¤§å»ˆç©¹é ‚ **å¿…é ˆ** æå‰å®˜ç¶²å…è²»é ç´„ã€‚",
                notes: "æŸæ—äº¤é€šåˆ†å€ ABCï¼Œå¸‚å€è²· AB å€å³å¯ã€‚",
                spots: [
                    { name: "å¸ƒè˜­ç™»å ¡é–€", type: "æ™¯é»", time: "09:30 | 1å°æ™‚", trans: "S-Bahn Brandenburger Tor", lat: 52.5163, lng: 13.3777 },
                    { name: "åœ‹æœƒå¤§å»ˆ (Reichstag)", type: "æ™¯é»", time: "11:00 | 1.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 52.5186, lng: 13.3761 },
                    { name: "çŒ¶å¤ªäººç´€å¿µç¢‘", type: "æ™¯é»", time: "14:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 52.5139, lng: 13.3815 }
                ]
            },
            {
                day: 21,
                date: "02/27 (äº”)",
                title: "æŸæ— | åšç‰©é¤¨å³¶æ–‡åŒ–å·¡ç¦®",
                city: "Berlin",
                coordinates: [52.5208, 13.3975],
                summary: "å…¨æ—¥æ¢ç´¢ä¸–ç•Œéºç”¢åšç‰©é¤¨å³¶ï¼Œé‡é»åœ¨ä½©åŠ è’™èˆ‡æ–°åšç‰©é¤¨ã€‚",
                tickets: "åšç‰©é¤¨å³¶è¯ç¥¨ (Museum Island Pass)ã€‚",
                notes: "ä½©åŠ è’™åšç‰©é¤¨(Pergamon)éƒ¨åˆ†æ•´ä¿®ä¸­ï¼Œéœ€ç¢ºèªé–‹æ”¾å€åŸŸã€‚æ–°åšç‰©é¤¨å¿…çœ‹å¨œèŠ™è’‚è’‚åƒã€‚",
                spots: [
                    { name: "åšç‰©é¤¨å³¶", type: "æ™¯é»", time: "10:00 | 4å°æ™‚", trans: "Bus 100/200 æˆ– U5", lat: 52.5195, lng: 13.3996 },
                    { name: "æŸæ—å¤§æ•™å ‚", type: "æ™¯é»", time: "15:00 | 1å°æ™‚", trans: "æ­¥è¡Œ", lat: 52.5190, lng: 13.4010 },
                    { name: "äºæ­·å±±å¤§å»£å ´", type: "é€›è¡—", time: "17:00 | 1.5å°æ™‚", trans: "æ­¥è¡Œ", lat: 52.5219, lng: 13.4132 }
                ]
            },
            {
                day: 22,
                date: "02/28 (å…­)",
                title: "æŸæ— | å†·æˆ°åœç‰†èˆ‡ç¾ä»£è—è¡“",
                city: "Berlin",
                coordinates: [52.5055, 13.4395],
                summary: "èµ°è¨ªæ±é‚Šç•«å»Š (æŸæ—åœç‰†) èˆ‡æŸ¥ç†æª¢æŸ¥å“¨ã€‚",
                tickets: "ç„¡ç‰¹æ®Šé–€ç¥¨ï¼Œåšç‰©é¤¨éœ€å¦è³¼ã€‚",
                notes: "æ±é‚Šç•«å»Šæ˜¯æˆ¶å¤–å€åŸŸï¼Œæ³¨æ„ä¿æš–ã€‚",
                spots: [
                    { name: "æ±é‚Šç•«å»Š (East Side Gallery)", type: "æ™¯é»", time: "10:00 | 1.5å°æ™‚", trans: "S-Bahn Ostbahnhof", lat: 52.5055, lng: 13.4395 },
                    { name: "æŸ¥ç†æª¢æŸ¥å“¨", type: "æ™¯é»", time: "13:00 | 1å°æ™‚", trans: "U6 Kochstr.", lat: 52.5074, lng: 13.3904 },
                    { name: "æ³¢èŒ²å¦å»£å ´", type: "æ™¯é»", time: "15:30 | 1.5å°æ™‚", trans: "U2/S-Bahn", lat: 52.5096, lng: 13.3759 }
                ]
            },
            {
                day: 23,
                date: "03/01 (æ—¥)",
                title: "æŸæ— | è³¼ç‰©èˆ‡æœ€å¾Œå·¡ç¦®",
                city: "Berlin",
                coordinates: [52.5036, 13.3353],
                summary: "é¸è³¼åº«é”å§†å¤§é“ç²¾å“æˆ–ç´€å¿µå“ï¼Œæº–å‚™è¿”ç¨‹ã€‚",
                tickets: "äº¤é€šç¥¨ã€‚",
                notes: "é€±æ—¥å•†åº—å¤§å¤šä¼‘æ¯ï¼å»ºè­°å®‰æ’è·³èš¤å¸‚å ´ (å¦‚ Mauerpark) æˆ–ç´”è§€å…‰ã€‚",
                spots: [
                    { name: "Mauerpark è·³èš¤å¸‚å ´", type: "é«”é©—", time: "10:00 | 3å°æ™‚", trans: "U2 Eberswalder Str.", lat: 52.5435, lng: 13.4024 },
                    { name: "å¤æ´›æ»•å ¡å®®", type: "æ™¯é»", time: "14:30 | 2å°æ™‚", trans: "Bus M45", lat: 52.5208, lng: 13.2956 }
                ]
            },
            {
                day: 24,
                date: "03/02 (ä¸€)",
                title: "è¿”ç¨‹ | æŸæ—æ©Ÿå ´",
                city: "Berlin",
                coordinates: [52.3667, 13.5033],
                summary: "å‰å¾€æŸæ—å¸ƒè˜­ç™»å ¡æ©Ÿå ´ (BER)ï¼ŒçµæŸç¾å¥½æ—…ç¨‹ã€‚",
                tickets: "ABC å€è»Šç¥¨ (å«æ©Ÿå ´)ã€‚",
                notes: "è«‹ææ—© 3 å°æ™‚æŠµé”æ©Ÿå ´è¾¦ç†é€€ç¨…èˆ‡ç™»æ©Ÿã€‚",
                spots: [
                    { name: "æŸæ—å¸‚å€ -> æ©Ÿå ´", type: "äº¤é€š", time: "09:00 | 45åˆ†", trans: "FEX æ©Ÿå ´å¿«ç·šæˆ– S9", lat: 52.5200, lng: 13.4050 },
                    { name: "æŸæ—å¸ƒè˜­ç™»å ¡æ©Ÿå ´ (BER)", type: "æ­æ©Ÿ", time: "13:00 | é£›é›¢", trans: "-", lat: 52.3667, lng: 13.5033 }
                ]
            }
        ];

        // --- Components ---

        // 1. Map Component (Using Raw Leaflet)
        const MapComponent = ({ activeSpot, activeDay, fullItinerary, onCityClick, onSpotMarkerClick }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersRef = useRef([]);
            const polylineRef = useRef(null);

            // Init Map
            useEffect(() => {
                if (!mapInstance.current && mapRef.current) {
                    mapInstance.current = L.map(mapRef.current).setView([48.1351, 11.5820], 6);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(mapInstance.current);
                }
            }, []);

            // Update Map View & Markers based on Active Day or Full View
            useEffect(() => {
                if (!mapInstance.current) return;

                const map = mapInstance.current;
                
                // Clear old markers and lines
                markersRef.current.forEach(m => map.removeLayer(m));
                markersRef.current = [];
                if (polylineRef.current) {
                    map.removeLayer(polylineRef.current);
                    polylineRef.current = null;
                }

                // --- Level 2 & 3: Day Mode (Always show all spots for the day) ---
                if (activeDay && activeDay.spots) {
                    const group = L.featureGroup();
                    activeDay.spots.forEach((spot, idx) => {
                       if(!isNaN(spot.lat) && !isNaN(spot.lng)) {
                           // Determine if this spot is the focused one
                           const isSelected = activeSpot && activeSpot.name === spot.name;
                           const colorClass = getCategoryColor(spot.type);
                           
                           // Create Icon: Add yellow border and scale effect if selected
                           const numberIcon = L.divIcon({
                               className: 'custom-number-icon',
                               html: `<div class="w-8 h-8 ${colorClass} rounded-full border-2 ${isSelected ? 'border-yellow-400 scale-110' : 'border-white'} text-white flex items-center justify-center font-bold shadow-md text-sm cursor-pointer transition-transform">${idx + 1}</div>`,
                               iconSize: [32, 32],
                               iconAnchor: [16, 16],
                               popupAnchor: [0, -16]
                           });

                           const marker = L.marker([spot.lat, spot.lng], { 
                               icon: numberIcon,
                               zIndexOffset: isSelected ? 1000 : 0 // Ensure selected marker is on top
                           })
                           .bindPopup(`<b>${spot.name}</b><br/>${spot.type}<br/>${spot.time}`)
                           .addTo(map)
                           // Add click event for Map-to-List interaction
                           .on('click', () => {
                               if(onSpotMarkerClick) onSpotMarkerClick(spot);
                           });

                           // Auto-open popup if selected
                           if (isSelected) {
                               marker.openPopup();
                           }

                           markersRef.current.push(marker);
                           group.addLayer(marker);
                       }
                   });

                   // FIT BOUNDS STRATEGY:
                   // Only fit bounds if NO specific spot is selected (Overview of Day).
                   // If a spot IS selected, the other useEffect handles the flyTo focus.
                   if (!activeSpot && markersRef.current.length > 0) {
                        const bounds = group.getBounds();
                        if (bounds.isValid()) {
                            // FIX: Use flyTo instead of fitBounds for smooth drone effect
                            const targetCenter = bounds.getCenter();
                            // Calculate zoom to fit bounds minus a small padding
                            const targetZoom = map.getBoundsZoom(bounds) - 0.5;
                            // Cap zoom to avoid getting too close if points are clustered
                            const finalZoom = Math.min(targetZoom, 15);
                            
                            map.flyTo(targetCenter, finalZoom, { 
                                duration: 1.5
                            });
                        }
                   }

                } else if (fullItinerary) {
                    // --- Level 1: Full View (Overview) Mode ---
                    // 1. Draw Polyline (Trajectory)
                    const trajectory = fullItinerary.map(d => d.coordinates);
                    const polyline = L.polyline(trajectory, { 
                        color: '#2563eb', // Blue-600
                        weight: 3, 
                        dashArray: '8, 8', // Dashed line for movement
                        opacity: 0.6 
                    }).addTo(map);
                    polylineRef.current = polyline;

                    // 2. Draw City Markers
                    const group = L.featureGroup();
                    fullItinerary.forEach((day, idx) => {
                        // Simple Circle Marker for cities
                        const marker = L.circleMarker(day.coordinates, {
                            radius: 6,
                            fillColor: '#fff',
                            color: '#2563eb',
                            weight: 2,
                            fillOpacity: 1,
                            className: 'cursor-pointer' // Add pointer cursor
                        }).addTo(map);

                        // Add tooltip instead of popup for cleaner hover
                        marker.bindTooltip(`<b>Day ${day.day}: ${day.city}</b>`, {
                            permanent: false,
                            direction: 'top'
                        });

                        // Add click event for Map-to-List interaction
                        marker.on('click', () => {
                            if(onCityClick) onCityClick(day.day);
                        });
                        
                        markersRef.current.push(marker);
                        group.addLayer(marker);
                    });

                    // 3. Fit Bounds
                    const bounds = polyline.getBounds();
                    if (bounds.isValid()) {
                        // FIX: Use flyTo for smooth overview transition
                        const targetCenter = bounds.getCenter();
                        const targetZoom = map.getBoundsZoom(bounds) - 0.5;
                        map.flyTo(targetCenter, targetZoom, { duration: 1.5 });
                    }
                }

            }, [activeDay, activeSpot, fullItinerary]); // Dependencies

            // FlyTo Effect for specific spot interaction (only when single spot active)
            useEffect(() => {
                if (mapInstance.current && activeSpot) {
                    const { lat, lng } = activeSpot;
                    if (!isNaN(lat) && !isNaN(lng)) {
                        mapInstance.current.flyTo([lat, lng], 15, { duration: 1.5 });
                    }
                }
            }, [activeSpot]);

            return <div id="map" ref={mapRef} className="h-full w-full z-0"></div>;
        };

        // 2. Sidebar Item (Day Card) - WITH ACCORDION ANIMATION
        const DayCard = ({ data, isActive, onClick, onSpotClick, activeSpot }) => {
            return (
                <div 
                    id={`day-${data.day}`} 
                    className={`border-b border-gray-200 transition-all duration-300 ${isActive ? 'bg-white shadow-lg' : 'bg-white hover:bg-gray-50'}`}
                >
                    <div 
                        className="p-4 cursor-pointer flex justify-between items-center sticky top-0 bg-white z-20"
                        onClick={onClick}
                    >
                        <div>
                            <div className="text-sm font-bold text-blue-600">Day {data.day} - {data.date}</div>
                            <h3 className="text-lg font-bold text-gray-800 mt-1">{data.title}</h3>
                        </div>
                        <div className="text-gray-400">
                            <i className={`fas fa-chevron-down transition-transform duration-300 ${isActive ? 'rotate-180' : ''}`}></i>
                        </div>
                    </div>

                    {/* Accordion Animation Wrapper using CSS Grid */}
                    <div className={`grid transition-[grid-template-rows] duration-300 ease-in-out ${isActive ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
                        <div className="overflow-hidden">
                            <div className="p-4 pt-0 text-sm text-gray-600 bg-gray-50/50">
                                <div className="mb-4 bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                                    <p className="font-semibold text-blue-800 mb-1"><i className="fas fa-info-circle mr-1"></i> è¡Œç¨‹æ‘˜è¦</p>
                                    <p>{data.summary}</p>
                                </div>
                                <div className="space-y-6 relative pl-6 border-l-2 border-gray-200 ml-4">
                                    {data.spots.map((spot, idx) => {
                                        const colorClass = getCategoryColor(spot.type);
                                        const isSpotActive = activeSpot && activeSpot.name === spot.name;

                                        return (
                                        <div key={idx} className={`relative group transition-all duration-300 rounded-lg ${isSpotActive ? 'bg-blue-50 -mx-2 px-2 py-2 shadow-sm' : ''}`}>
                                            <div className={`absolute ${isSpotActive ? 'left-[0px]' : '-left-[35px]'} top-2 h-8 w-8 rounded-full ${colorClass} border-2 border-white text-white flex items-center justify-center text-sm font-bold shadow-sm z-10 transition-all duration-300`}>
                                                {idx + 1}
                                            </div>
                                            <div className={`flex justify-between items-start transition-all duration-300 ${isSpotActive ? 'pl-10' : ''}`}>
                                                <div className="flex-1">
                                                    <h4 className={`font-bold text-base transition-colors duration-300 ${isSpotActive ? 'text-blue-800' : 'text-gray-800'}`}>
                                                        {data.city} | {spot.name}
                                                    </h4>
                                                    <div className="flex flex-col mt-1 space-y-1">
                                                         <span className="text-xs inline-flex items-center text-gray-500 bg-gray-100 px-2 py-0.5 rounded w-fit">
                                                            <i className="fas fa-clock mr-1.5 w-3"></i> {spot.time}
                                                        </span>
                                                        <span className="text-xs inline-flex items-center text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded w-fit">
                                                            <i className="fas fa-train mr-1.5 w-3"></i> {spot.trans}
                                                        </span>
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); onSpotClick(spot); }}
                                                    className={`ml-2 px-2 py-1 border rounded text-xs transition-all duration-300 shadow-sm ${isSpotActive ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-gray-300 hover:bg-blue-50 hover:text-blue-600'}`}
                                                >
                                                    <i className="fas fa-map-marker-alt mr-1"></i>
                                                    {isSpotActive ? 'èšç„¦ä¸­' : 'åœ°åœ–'}
                                                </button>
                                            </div>
                                        </div>
                                        );
                                    })}
                                </div>
                                <div className="mt-8 grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div className="bg-amber-50 p-3 rounded border border-amber-100">
                                        <h5 className="font-bold text-amber-700 mb-1 text-xs uppercase"><i className="fas fa-ticket-alt mr-1"></i> ç¥¨åˆ¸ç­–ç•¥</h5>
                                        <p className="text-xs text-amber-900">{data.tickets}</p>
                                    </div>
                                    <div className="bg-purple-50 p-3 rounded border border-purple-100">
                                        <h5 className="font-bold text-purple-700 mb-1 text-xs uppercase"><i className="fas fa-snowflake mr-1"></i> å†¬å­£æ³¨æ„</h5>
                                        <p className="text-xs text-purple-900">{data.notes}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Search Component (Spots Database) - Unchanged
        const SearchTab = ({ data, onSpotClick }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const allSpots = useMemo(() => {
                let spots = [];
                data.forEach(day => {
                    day.spots.forEach(spot => {
                        spots.push({ ...spot, day: day.day, date: day.date, city: day.city, country: getCountry(day.city) });
                    });
                });
                return spots.sort((a, b) => {
                    if (a.country !== b.country) return a.country.localeCompare(b.country, "zh-TW");
                    if (a.city !== b.city) return a.city.localeCompare(b.city);
                    return a.day - b.day;
                });
            }, [data]);
            const filteredSpots = allSpots.filter(spot => 
                spot.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                spot.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
                spot.country.includes(searchTerm)
            );
            return (
                <div className="h-full flex flex-col bg-white">
                    <div className="p-4 border-b bg-gray-50">
                        <div className="relative">
                            <i className="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" className="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="æœå°‹åœ‹å®¶ã€åŸå¸‚ã€æ™¯é»..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="text-xs text-gray-500 mt-2 flex justify-between">
                            <span>æ”¶éŒ„ {allSpots.length} å€‹åœ°é» (ä¾åœ‹å®¶æ’åº)</span>
                            <span>{filteredSpots.length} å€‹æœå°‹çµæœ</span>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {filteredSpots.length > 0 ? (
                            filteredSpots.map((spot, idx) => {
                                const colorClass = getCategoryColor(spot.type);
                                const rating = spot.type === 'æ™¯é»' ? 'ğŸ”¥ å¿…å»' : spot.type === 'é¤é£²' ? 'ğŸ‘ æ¨è–¦' : 'ğŸ“ ä¸€èˆ¬';
                                return (
                                <div key={idx} className="bg-white border rounded-lg p-3 hover:shadow-md cursor-pointer transition-shadow flex justify-between items-center" onClick={() => onSpotClick(spot)}>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1"><span className="font-semibold text-blue-600">{spot.country}</span> Â· {spot.city} Â· Day {spot.day}</div>
                                        <h4 className="font-bold text-gray-800">{spot.name}</h4>
                                        <div className="flex gap-2 mt-2"><span className="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-600 rounded">{spot.type}</span><span className="text-[10px] px-2 py-0.5 bg-yellow-50 text-yellow-700 rounded border border-yellow-100">{rating}</span></div>
                                    </div>
                                    <div className={`w-8 h-8 rounded-full ${colorClass} text-white flex items-center justify-center shrink-0`}><i className="fas fa-map-marker-alt"></i></div>
                                </div>
                                )
                            })
                        ) : (<div className="text-center text-gray-400 mt-10"><i className="fas fa-ghost text-4xl mb-3"></i><p>æ‰¾ä¸åˆ°ç›¸é—œæ™¯é»</p></div>)}
                    </div>
                </div>
            );
        };

        // 4. Winter Guide Component - Unchanged
        const GuideTab = () => {
             return (
                <div className="h-full overflow-y-auto bg-white p-5">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">å†¬å­£ç”Ÿå­˜æŒ‡å— <span className="text-sm font-normal text-gray-500 block mt-1">Winter Survival Guide</span></h2>
                    
                    <div className="space-y-6">
                        {/* Weather */}
                        <section className="bg-sky-50 p-4 rounded-xl border border-sky-100">
                            <h3 className="font-bold text-sky-800 text-lg mb-2"><i className="fas fa-sun mr-2"></i>æ—¥ç…§èˆ‡å¤©æ°£</h3>
                            <ul className="list-disc pl-5 text-sm text-sky-900 space-y-1">
                                <li><strong>å¹³å‡æ°£æº«ï¼š</strong>-2Â°C è‡³ 5Â°C (2æœˆ)ã€‚</li>
                                <li><strong>æ—¥å‡ºæ—¥è½ï¼š</strong>ç´„ 07:30 æ—¥å‡ºï¼Œ17:30 æ—¥è½ã€‚</li>
                                <li><strong>é»ƒé‡‘æ™‚åˆ»ï¼š</strong>æŠŠæ¡ 10:00 - 15:00 æ‹æ”æœ€ä½³å…‰ç·šã€‚</li>
                                <li><strong>æ³¨æ„ï¼š</strong>ä¸­æ­å®¤å…§æš–æ°£æ¥µå¼· (ç´„20-25Â°C)ï¼Œæ¡ç”¨ã€Œæ´‹è”¥å¼ç©¿æ­ã€ã€‚</li>
                            </ul>
                        </section>

                        {/* Clothing */}
                        <section className="bg-rose-50 p-4 rounded-xl border border-rose-100">
                            <h3 className="font-bold text-rose-800 text-lg mb-2"><i className="fas fa-tshirt mr-2"></i>ç©¿è‘—å»ºè­°</h3>
                            <div className="text-sm text-rose-900">
                                <p className="mb-2 font-semibold">å¿…å‚™æ¸…å–®ï¼š</p>
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="bg-white p-2 rounded text-center shadow-sm">é˜²é¢¨é˜²æ°´å¤§è¡£</div>
                                    <div className="bg-white p-2 rounded text-center shadow-sm">ç™¼ç†±è¡£è¤² (Uniqlo)</div>
                                    <div className="bg-white p-2 rounded text-center shadow-sm">ç¾Šæ¯›è¥ª (åš)</div>
                                    <div className="bg-white p-2 rounded text-center shadow-sm">é˜²æ»‘é˜²æ°´é´</div>
                                    <div className="bg-white p-2 rounded text-center shadow-sm">æ¯›å¸½ (è“‹è€³)</div>
                                    <div className="bg-white p-2 rounded text-center shadow-sm">æ‰‹å¥— (å¯è§¸æ§)</div>
                                </div>
                            </div>
                        </section>

                        {/* Emergency */}
                        <section className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <h3 className="font-bold text-gray-800 text-lg mb-2"><i className="fas fa-phone-alt mr-2"></i>ç·Šæ€¥è³‡è¨Š</h3>
                            <div className="space-y-3 text-sm">
                                <div className="flex justify-between border-b pb-2">
                                    <span>æ­ç›Ÿé€šç”¨ç·Šæ€¥é›»è©±</span>
                                    <span className="font-mono font-bold text-red-600">112</span>
                                </div>
                                <div className="flex justify-between border-b pb-2">
                                    <span>å¾·åœ‹å ±è­¦/æ€¥æ•‘</span>
                                    <span className="font-mono font-bold">110 / 112</span>
                                </div>
                                <div className="flex justify-between border-b pb-2">
                                    <span>å¥§åœ°åˆ©å ±è­¦/æ€¥æ•‘</span>
                                    <span className="font-mono font-bold">133 / 144</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>æ·å…‹/åŒˆç‰™åˆ©å ±è­¦</span>
                                    <span className="font-mono font-bold">158 / 107</span>
                                </div>
                            </div>
                        </section>

                        {/* City Cards */}
                        <section className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <h3 className="font-bold text-emerald-800 text-lg mb-2"><i className="fas fa-money-bill-wave mr-2"></i>åŸå¸‚å¡æ”»ç•¥</h3>
                            <div className="space-y-4 text-sm text-emerald-900">
                                <div>
                                    <h4 className="font-bold">Salzburg Card (å¿…è²·)</h4>
                                    <p className="opacity-80">å«æ‰€æœ‰æ™¯é»é–€ç¥¨èˆ‡äº¤é€šï¼Œå»è¦å¡å’Œæµ·çˆ¾å¸ƒå€«å®®å°±å›æœ¬ã€‚</p>
                                </div>
                                <div>
                                    <h4 className="font-bold">Vienna City Card (é¸è³¼)</h4>
                                    <p className="opacity-80">ä¸»è¦çœäº¤é€šè²»ï¼Œåšç‰©é¤¨åƒ…æ‰“æŠ˜ã€‚å»ºè­°è²·äº¤é€šé€±ç¥¨ + å€‹åˆ¥é–€ç¥¨ã€‚</p>
                                </div>
                                <div>
                                    <h4 className="font-bold">Budapest Card (ä¸æ¨è–¦)</h4>
                                    <p className="opacity-80">CPå€¼ä½ã€‚è²· 72hr Travel Card + å€‹åˆ¥è³¼ç¥¨è¼ƒåˆ’ç®—ã€‚</p>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        // 5. Main App Layout
        const App = () => {
            const [activeTab, setActiveTab] = useState('timeline'); // timeline, search, guide
            const [activeDayId, setActiveDayId] = useState(null); 
            const [activeSpot, setActiveSpot] = useState(null);
            const [isHeaderExpanded, setIsHeaderExpanded] = useState(false); // Mobile header expansion state

            const activeDayData = itineraryData.find(d => d.day === activeDayId);

            // Handler: Logic for List Header Clicks (The 3-Level Logic)
            const handleDayHeaderClick = (dayId) => {
                if (activeDayId === dayId) {
                    if (activeSpot) {
                        // Level 3 -> Level 2 (Clear spot, show day overview)
                        setActiveSpot(null);
                    } else {
                        // Level 2 -> Level 1 (Collapse day, show trip overview)
                        setActiveDayId(null);
                    }
                } else {
                    // Level 1 -> Level 2 or Level 2 -> Level 2 (Switch day)
                    setActiveDayId(dayId);
                    setActiveSpot(null);
                }
            };

            // Handler: Logic for Spot Click (in List) -> Level 3
            const handleSpotClick = (spot) => {
                setActiveSpot(spot);
                if (spot.day) setActiveDayId(spot.day);
            };

            // Handler: Logic for Map City Click (L1 -> L2)
            const handleMapCityClick = (dayId) => {
                setActiveDayId(dayId);
                setActiveSpot(null);
                setActiveTab('timeline'); // Ensure we are on timeline tab
            };

            // Handler: Logic for Map Marker Click (L2 -> L3)
            const handleMapSpotMarkerClick = (spot) => {
                setActiveSpot(spot);
                // Also ensure day is active (should be already, but just in case)
                if (spot.day && activeDayId !== spot.day) setActiveDayId(spot.day);
            };

            // Effect: Auto-scroll to Day or Spot when active state changes
            useEffect(() => {
                // We use a small timeout to let the DOM render the expanded list first
                setTimeout(() => {
                    if (activeDayId && !activeSpot) {
                        // Scroll to Day Header
                        const el = document.getElementById(`day-${activeDayId}`);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } 
                    // Note: Scrolling to individual spot is tricky because we didn't add IDs to spots easily
                    // but focusing on the Day is usually good enough for L2 transition.
                }, 100);
            }, [activeDayId]);

            return (
                <div className="flex flex-col md:flex-row h-screen w-full">
                    
                    {/* Left Column Container (List & Tabs) */}
                    <div className="w-full md:w-5/12 lg:w-4/12 h-[70%] md:h-full bg-white shadow-[0_-5px_15px_rgba(0,0,0,0.1)] md:shadow-xl z-20 flex flex-col relative order-2 md:order-1">
                        
                        {/* Header */}
                        <header 
                            className="px-3 py-2 md:px-4 md:py-3 bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-md shrink-0 z-30 transition-all cursor-pointer md:cursor-default"
                            onClick={() => setIsHeaderExpanded(!isHeaderExpanded)}
                        >
                            <div className="flex items-center justify-between">
                                <div className="flex flex-col w-full">
                                    <div className="flex items-center justify-between w-full">
                                        <h1 className="text-sm md:text-base font-bold flex items-center leading-none">
                                            <i className="fas fa-snowflake mr-2 opacity-80 text-xs"></i>
                                            24å¤©ä¸­æ­å†¬å­£ä¹‹æ—…
                                            <i className={`fas fa-chevron-down md:hidden ml-2 text-[10px] transition-transform duration-300 ${isHeaderExpanded ? 'rotate-180' : ''}`}></i>
                                        </h1>
                                        {!isHeaderExpanded && activeDayId && (
                                            <span className="md:hidden text-[10px] font-mono bg-blue-800/50 px-2 py-0.5 rounded border border-blue-500/30 whitespace-nowrap animate-fade-in">
                                                Day {activeDayId}
                                            </span>
                                        )}
                                    </div>
                                    <div className={`${isHeaderExpanded ? 'flex' : 'hidden'} md:flex mt-1 md:mt-1 transition-all justify-between items-center`}>
                                        <span className="text-[10px] text-blue-200">2026/02/07 - 03/02</span>
                                        <span className="bg-blue-800 px-2 py-0.5 rounded text-[10px] shadow-sm whitespace-nowrap border border-blue-600">
                                            å¤§çœ¾é‹è¼¸ç‰ˆ
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </header>

                        {/* Content Area (Scrollable) */}
                        <div className="flex-1 overflow-hidden relative bg-gray-50">
                            {/* Wrap content in animated container with key for fade effect */}
                            <div key={activeTab} className="h-full animate-fade-in">
                                {activeTab === 'timeline' && (
                                    <div className="h-full overflow-y-auto">
                                        {itineraryData.map(day => (
                                            <DayCard 
                                                key={day.day} 
                                                data={day} 
                                                isActive={activeDayId === day.day}
                                                activeSpot={activeSpot}
                                                onClick={() => handleDayHeaderClick(day.day)}
                                                onSpotClick={handleSpotClick}
                                            />
                                        ))}
                                        <div className="p-3 bg-gray-100 text-center text-xs text-gray-500 border-t h-20"></div>
                                    </div>
                                )}
                                
                                {activeTab === 'search' && (
                                    <SearchTab data={itineraryData} onSpotClick={handleSpotClick} />
                                )}

                                {activeTab === 'guide' && (
                                    <GuideTab />
                                )}
                            </div>
                        </div>

                        {/* Bottom Tab Navigation */}
                        <div className="bg-white border-t flex justify-around items-center h-16 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 pb-safe">
                            <button 
                                onClick={() => setActiveTab('timeline')}
                                className={`flex flex-col items-center justify-center w-full h-full transition-colors duration-300 ${activeTab === 'timeline' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}
                            >
                                <i className="fas fa-list-ul text-lg mb-1 transform transition-transform duration-300 ${activeTab === 'timeline' ? 'scale-110' : ''}"></i>
                                <span className="text-xs font-medium">æ¯æ—¥è¡Œç¨‹</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('search')}
                                className={`flex flex-col items-center justify-center w-full h-full transition-colors duration-300 ${activeTab === 'search' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}
                            >
                                <i className="fas fa-search text-lg mb-1 transform transition-transform duration-300 ${activeTab === 'search' ? 'scale-110' : ''}"></i>
                                <span className="text-xs font-medium">æ™¯é»æœå°‹</span>
                            </button>
                            <button 
                                onClick={() => setActiveTab('guide')}
                                className={`flex flex-col items-center justify-center w-full h-full transition-colors duration-300 ${activeTab === 'guide' ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600'}`}
                            >
                                <i className="fas fa-book-open text-lg mb-1 transform transition-transform duration-300 ${activeTab === 'guide' ? 'scale-110' : ''}"></i>
                                <span className="text-xs font-medium">ç”Ÿå­˜æŒ‡å—</span>
                            </button>
                        </div>
                    </div>

                    {/* Right Column: Map */}
                    <div className="w-full md:w-7/12 lg:w-8/12 h-[30%] md:h-full relative border-b md:border-b-0 md:border-l border-gray-300 order-1 md:order-2">
                        <MapComponent 
                            activeDay={activeDayData} 
                            activeSpot={activeSpot} 
                            fullItinerary={itineraryData} 
                            onCityClick={handleMapCityClick}
                            onSpotMarkerClick={handleMapSpotMarkerClick}
                        />
                        
                        {/* Map Overlay Info - With Animation */}
                        <div className="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded-lg shadow-lg z-[400] max-w-xs hidden md:block border border-gray-200 transition-all duration-300 hover:shadow-xl">
                            {/* Use Key to trigger re-animation on change */}
                            <div key={activeDayId ? `day-${activeDayId}` : 'overview'} className="animate-fade-in">
                                {activeDayData ? (
                                    <>
                                        <h4 className="text-sm font-bold text-gray-800">ç›®å‰æª¢è¦–ï¼šDay {activeDayId}</h4>
                                        <p className="text-xs text-gray-600 mt-1">{activeDayData.city}</p>
                                        {activeSpot && (
                                            <div className="mt-2 pt-2 border-t border-gray-200 animate-fade-in">
                                                <span className="text-xs font-bold text-blue-600">èšç„¦ä¸­ï¼š</span>
                                                <span className="text-xs">{activeSpot.name}</span>
                                            </div>
                                        )}
                                    </>
                                ) : (
                                    <div className="text-xs text-gray-800">
                                        <i className="fas fa-map mr-1 text-blue-600"></i>
                                        <b>å…¨è¦½æ¨¡å¼</b>ï¼šé¡¯ç¤º 24 å¤©è·¨åœ‹ç§»å‹•è»Œè·¡
                                        <p className="text-gray-500 mt-1 font-normal">é»æ“Šå·¦å´åˆ—è¡¨æŸ¥çœ‹æ¯æ—¥è©³ç´°è¡Œç¨‹</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
